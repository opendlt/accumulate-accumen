# CLAUDE-ORCH.md â€” Accumen Orchestration (Local Windows)

This file is the ONLY place Claude Code should read instructions from when generating/updating files.

## How to run Claude Code

Use this every time:
```powershell
claude --ide `
  --allowed-tools "Bash(dart*|pwsh*|powershell*|cmake*|ninja*|git*|where*|cmd*|dumpbin*), Read, Write, Edit" `
  --add-dir "C:\Dev\accumulate-accumen" `
  --add-dir "C:\Accumulate_Stuff\accumulate" `
  --add-dir "C:\Accumulate_Stuff\accumulate\vdk" `
  --add-dir "C:\Accumulate_Stuff\accumulate-javascript-client" `
  --permission-mode acceptEdits
```

## Filesystem Contract

**CRITICAL:** Claude Code MUST use the Write tool to create files. Fenced code blocks are NOT sufficient.

- **Write target**: `C:\Dev\accumulate-accumen` (first --add-dir)
- **Read-only references**: Other --add-dir paths
- **File paths**: Use forward slashes, relative to write target
- **Required**: Use Write tool after generating content

## Project Overview

Accumen is a Go 1.22+ L1 sequencer with:
- WASM runtime (wazero, deterministic)
- Accumulate L0 bridge integration
- VDK compatibility
- Sequencer/follower modes

## Key Commands

### Development
```bash
make build           # Build binary
make run-sequencer   # Run with config/local.yaml
make test            # Unit tests
make test-integration # Integration tests
make test-e2e        # End-to-end tests
make generate        # Generate proto + json types
```

### Code Generation
```bash
make proto           # Generate protobuf types
make json            # Generate JSON schema types
```

## Architecture

### Core Components
- `cmd/accumen/` - Main entry point
- `sequencer/` - Block production and transaction ordering
- `engine/` - WASM execution environment
- `bridge/` - Accumulate L0 integration
- `types/` - Schema definitions and code generation
- `sdk/rust/` - Rust contract SDK

### Key Files
- `config/local.yaml` - Local development config
- `sequencer/loop.go` - Main sequencer orchestration
- `engine/runtime/runtime.go` - WASM runtime
- `bridge/anchors/dn_writer.go` - L0 metadata writing
- `types/json/metadata_builder.go` - Transaction metadata

## Development Rules

1. **Always use Write tool** for file creation/modification
2. **Use config/local.yaml** for local development (bridge disabled)
3. **Run make generate** after schema changes
4. **Test before commit** with make test
5. **Follow Go conventions** and existing patterns

## Testing Infrastructure

- `tests/harness/` - Integration test framework
- `tests/e2e/` - End-to-end test scenarios
- Mock WASM contracts for testing
- Test configuration in harness

## SDK Development

### Rust SDK
- `sdk/rust/accumen-abi/` - Core ABI bindings
- `sdk/rust/examples/counter/` - Example contract
- Build: `cargo build --target wasm32-unknown-unknown --release`

### Host Functions
Available in WASM contracts:
- State: `accuwasm_get`, `accuwasm_set`, `accuwasm_delete`
- Gas: `accuwasm_gas_remaining`, `accuwasm_gas_consume`
- Context: `accuwasm_tx_get_id`, `accuwasm_block_height`
- Logging: `accuwasm_log`

## Configuration

### Local Development (`config/local.yaml`)
- Bridge disabled (enable_bridge: false)
- Fast blocks (1s)
- Debug logging
- In-memory storage

### Key Settings
- `block_time`: Block production interval
- `execution.workers`: Parallel execution workers
- `mempool.max_size`: Transaction pool limit
- `bridge.enable_bridge`: L0 integration toggle

## File Generation Patterns

### When modifying schemas:
1. Update schema file (`types/json/*.schema.json` or `types/proto/*.proto`)
2. Run `make generate`
3. Update dependent code
4. Add/update tests

### When adding components:
1. Follow existing package structure
2. Add tests in same package
3. Update integration if needed
4. Document in appropriate README/docs

## Documentation

- `docs/ARCHITECTURE.md` - System design overview
- `docs/RUNBOOK.md` - Operations guide
- `CLAUDE.md` - Development notes
- Code comments - Comprehensive inline documentation

## Emergency Instructions

If Claude Code encounters errors:
1. Check file paths (use forward slashes, relative paths)
2. Ensure Write tool usage (not just fenced blocks)
3. Verify directory structure matches expectations
4. Check Go module path consistency
5. Run make generate after schema changes

## Commit Guidelines

After each successful generation session:
1. Verify all files created with Write tool
2. Run `make test` to ensure no regressions
3. Commit with descriptive message
4. Include both generated and manual changes

Last updated: Generated by Claude Code